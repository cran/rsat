<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>3. Customize</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">

div.csl-bib-body { }
div.csl-entry {
clear: both;
}
.hanging div.csl-entry {
margin-left:2em;
text-indent:-2em;
}
div.csl-left-margin {
min-width:2em;
float:left;
}
div.csl-right-inline {
margin-left:2em;
padding-left:1em;
}
div.csl-indent {
margin-left: 2em;
}
</style>

<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">3. Customize</h1>



<div id="customize" class="section level1">
<h1>Customize</h1>
<p><strong>Customizing</strong> means transforming raw images into
useful information for particular needs. Customizing includes; (1)
mosaicking, i.e. joining scenes of a region and date in a single file ,
(2) calculating and index to highlight the presence of process/material
in the satellite image, and (3) mask the cloudy pixels to avoid
misinterpreting the surface reflectance values. This demo builds on the
showcase from the search vignette and so, the first section reviews the
most important code from the previous vignette.</p>
<hr />
<div id="review" class="section level2">
<h2>Review</h2>
<p>As a first step of <code>rsat</code>’s workflow is specifying the
credentials for the the web services:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(rsat)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">set_credentials</span>(<span class="st">&quot;rsat.package&quot;</span>,<span class="st">&quot;UpnaSSG.2021&quot;</span>)</span></code></pre></div>
<p>The showcase aims at assessing the effect of the <a href="https://en.wikipedia.org/wiki/2020%E2%80%9321_European_windstorm_season#Storm_Filomena">Snowstorm
Filomena</a> on the Iberian peninsula during January <span class="math inline">\(10^{th}\)</span> and <span class="math inline">\(15^{th}\)</span>, <span class="math inline">\(2021\)</span>. Hence, the <em>roi</em> and
<em>toi</em> correspond to an <code>sf</code> polygon around the
peninsula (<code>ip</code>) and a vector of dates (<code>toi</code>)
covering the time-span:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>ip <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(<span class="fu">st_as_sfc</span>(<span class="fu">st_bbox</span>(<span class="fu">c</span>(</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>  <span class="at">xmin =</span> <span class="sc">-</span><span class="fl">9.755859</span>,</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  <span class="at">xmax =</span>  <span class="fl">4.746094</span>,</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  <span class="at">ymin =</span> <span class="fl">35.91557</span>,</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>  <span class="at">ymax =</span> <span class="fl">44.02201</span> </span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>), <span class="at">crs =</span> <span class="dv">4326</span>)))</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>toi <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">&quot;2021-01-10&quot;</span>),<span class="fu">as.Date</span>(<span class="st">&quot;2021-01-15&quot;</span>),<span class="dv">1</span>)</span></code></pre></div>
<p>The folders for the database and dataset can be created
programmatically as follows:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>db.path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">tempdir</span>(),<span class="st">&quot;database&quot;</span>)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>ds.path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">tempdir</span>(),<span class="st">&quot;datasets&quot;</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="fu">dir.create</span>(db.path)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="fu">dir.create</span>(ds.path)</span></code></pre></div>
<p>The minimum information to generate a new <code>rtoi</code> is a
<code>name</code> for the object, a polygon of the region of interest
(<em>roi</em>), and the paths to the database and dataset:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>filomena <span class="ot">&lt;-</span> <span class="fu">new_rtoi</span>(<span class="at">name =</span> <span class="st">&quot;filomena&quot;</span>,</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>                     <span class="at">region =</span> ip,</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>                     <span class="at">db_path =</span> db.path,</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>                     <span class="at">rtoi_path =</span> ds.path)</span></code></pre></div>
<p>To limit the amount of data and processing times, the assessment is
conducted over MODIS imagery. A total number of <span class="math inline">\(24\)</span> images are found for the region over
the <span class="math inline">\(6\)</span>-day period:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">rsat_search</span>(<span class="at">region =</span> filomena, <span class="at">product =</span> <span class="fu">c</span>(<span class="st">&quot;mod09ga&quot;</span>), <span class="at">dates =</span> toi)</span></code></pre></div>
<p>The way to download the search results is as follows:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">rsat_download</span>(filomena)</span></code></pre></div>
<hr />
</div>
<div id="mosaic" class="section level2">
<h2>Mosaic</h2>
<p><strong><em>Mosaicking</em></strong> involves binding together
several images of a region from the same date. The function
<code>mosaic()</code> finds automatically the relevant images in the
database and joins them together in a single file. Additionally, by
default, the function crops around the <em>roi</em> of the
<code>rtoi</code> to remove unnecessary information and save space on
your hard disk drive:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">rsat_mosaic</span>(filomena)</span></code></pre></div>
<p>The cropping option can be disabled with the argument
<code>warp = NULL</code>. Here, cropping is appropriate since images
extend far beyond our region of interest.</p>
<p>The results are saved under <code>rtoi_path</code> inside
Modis/mod09ga/mosaic
(i.e. <em>constellation_name/data_product_name/mosaic</em>). This is the
first time in the workflow that the <code>rtoi_path</code> is being
used. The reason is that mosaicking is the first transformation applied
to the raw images to better fit the particular needs of the analysis.
The outcomes from the mosaic are compressed (<em>zip)</em> to minimize
their size:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">list.files</span>(<span class="fu">file.path</span>(ds.path, <span class="st">&quot;filomena&quot;</span>, <span class="st">&quot;Modis/mod09ga/mosaic&quot;</span>), <span class="at">full.name =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>At this point of the workflow, <em>RGB</em> representations of the
satellite images can be displayed on the fly, without loading the entire
image in <code>R</code>. By default, the <code>plot()</code> method for
an <code>rtoi</code> displays the mosaicked images when the object is
not followed by the words <code>&quot;preview&quot;</code> or <code>&quot;date&quot;</code>
(see other types of plots for an <code>rtoi</code> in the search
vignette):</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">plot</span>(filomena, <span class="fu">as.Date</span>(<span class="st">&quot;2021-01-11&quot;</span>))</span></code></pre></div>
<p>The map shows a sample of pixels from the original image. This is a
strategy to save space in <em>RAM</em> memory. The downside is the
reduction in the level of detail of the image. By default, the number of
pixels on the horizontal and vertical axis is <span class="math inline">\(250\)</span>. The arguments <code>xsize</code> and
<code>ysize</code> change the size of the sample to vary the crispness
of the image. The code below doubles the number of pixels on each axis
of the image;</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">plot</span>(filomena, <span class="fu">as.Date</span>(<span class="st">&quot;2021-01-11&quot;</span>),<span class="at">xsize =</span> <span class="dv">500</span>, <span class="at">ysize =</span> <span class="dv">500</span>)</span></code></pre></div>
<p>Clouds and snow are visually similar. False color images are
frequently used in the field in order to ease the detection of features.
False color images switch the natural color in the <em>RGB</em> image to
other bands. These kind of representations can be built using the
<code>band_name</code> argument followed by the name of the bands
replacing the <em>red</em>, <em>green</em>, and <em>blue</em> colors.
For instance, the rendering of <em>swir1</em>, <em>nir</em>, and
<em>blue</em> highlights the snow in blue color:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">plot</span>(filomena,</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>     <span class="fu">as.Date</span>(<span class="st">&quot;2021-01-11&quot;</span>),</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>     <span class="at">xsize =</span> <span class="dv">500</span>,</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>     <span class="at">ysize =</span> <span class="dv">500</span>,</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>     <span class="at">band_name =</span> <span class="fu">c</span>(<span class="st">&quot;swir1&quot;</span>, <span class="st">&quot;nir&quot;</span>, <span class="st">&quot;blue&quot;</span>))</span></code></pre></div>
</div>
<div id="index-calculation" class="section level2">
<h2>Index calculation</h2>
<div id="definition" class="section level3">
<h3>Definition</h3>
<p>A <strong><em>remote sensing index</em></strong> is an indicator that
reveals the presence of a material in a satellite image. Indexes are the
result of simple math applied to the bands of an image. The computation
involves the bands with a distinctively high or low reflectance for the
feature at hand. Over the years, researchers have developed a wide
variety of indexes for different materials or processes which can be
consulted <a href="https://www.indexdatabase.de/db/i.php">here</a>.</p>
<p>For instance, the <em>Normalized Difference Snow Index</em> (NDSI)
(see e.g., <span class="citation">(Salomonson and Appel 2004)</span>)
highlights the snow using the <em>green</em> and
<em>shortwave-infrared</em> bands (around <span class="math inline">\(1.5 \mu m\)</span>). The subtraction of this two
bands gives a large number for those pixels depicting snow. The
denominator ensures that values oscillate between <span class="math inline">\(-1\)</span> and <span class="math inline">\(1\)</span>.</p>
<p><span class="math display">\[ NDSI = \frac{Green - SWIR1}{Green +
SWIR1}\]</span></p>
</div>
<div id="calculation" class="section level3">
<h3>Calculation</h3>
<p>In <code>R</code> we can create a function replicating the
calculation of the <em>NDSI</em> index<em>:</em></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>NDSI <span class="ot">=</span> <span class="cf">function</span>(green, swir1){</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>  ndsi <span class="ot">&lt;-</span> (green <span class="sc">-</span> swir1)<span class="sc">/</span>(green <span class="sc">+</span> swir1)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  <span class="fu">return</span>(ndsi)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>}</span></code></pre></div>
<p><code>rsat</code> demands that these formulas use the band names,
e.g. <em>red, green, blue, etc.</em> rather than band number. Band names
and numbers differ among mission/satellites. For instance, the
<em>green</em> corresponds to the band number <span class="math inline">\(4\)</span> in MODIS and Landsat-7, number <span class="math inline">\(3\)</span> in Landsat-8 and Sentinel-2, and number
<span class="math inline">\(6\)</span> in Sentinel-3 (see <a href="https://drive.google.com/file/d/1cSw4LaTLPlGBHmG8v7uwH54f-m9jZz1N/view?usp=sharing">here</a>).
Using their names enables the use of a unique custom function across
satellites/missions. <code>rsat</code> functions are responsible for
linking the name to the corresponding band number according to the
mission. Some widespread variables are built-in the package and the list
of variables can be printed using;</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">show_variables</span>()</span></code></pre></div>
<p>To use the <code>NDSI()</code> function over the series of satellite
images of the Iberian peninsula, use the function <code>derive()</code>
as follows;</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">rsat_derive</span>(filomena, <span class="at">product =</span> <span class="st">&quot;mod09ga&quot;</span>, <span class="at">variable =</span> <span class="st">&quot;ndsi&quot;</span>, <span class="at">fun =</span> NDSI)</span></code></pre></div>
<p>Again, you can plot the results without loading the scenes in
<code>R</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">plot</span>(filomena,</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>     <span class="fu">as.Date</span>(<span class="st">&quot;2021-01-11&quot;</span>),</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>     <span class="at">variable =</span> <span class="st">&quot;ndsi&quot;</span>,</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>     <span class="at">xsize =</span> <span class="dv">500</span>,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>     <span class="at">ysize =</span> <span class="dv">500</span>,</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>     <span class="at">zlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code></pre></div>
<p>The <em>NDSI</em> index improves the separability between clouds and
snow. However, there might be some difficulties distinguishing between
them in certain parts of the image. As a solution, the next step removes
cloud-covered pixels.</p>
</div>
</div>
<div id="cloud-removal" class="section level2">
<h2>Cloud removal</h2>
<p>Some data providers apply algorithms over their data-sets to detect
the presence of clouds (Level 1/2 products). The analysis is part of the
quality assessment done during pre-processing and the results are
included in the <strong><em>Quality Assurance</em></strong>
(<em>QA</em>) band of the image. In addition to cloud coverage, the band
provides information about over-saturated or filled pixels. The
information is packed in this band using the bit format.</p>
<p>The function <code>cloud_mask()</code> interprets the <em>QA</em>
band to obtain images showing the presence/absence of clouds. Its
application is straightforward;</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fu">rsat_cloudMask</span>(filomena)</span></code></pre></div>
<p>To apply the cloud mask, we need to import the <em>NDSI</em> images
into <code>R</code> using the <code>get_raster()</code> function. The
values of the index must be truncated between <span class="math inline">\(-1\)</span> and <span class="math inline">\(1\)</span> to avoid values outside the feasible
range (sun reflections on mirror-like surfaces, such as water, can lead
to misleading results):</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>ndsi.img <span class="ot">&lt;-</span> <span class="fu">rsat_get_raster</span>(filomena, <span class="st">&quot;mod09ga&quot;</span>, <span class="st">&quot;ndsi&quot;</span>)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>ndsi.img <span class="ot">&lt;-</span> <span class="fu">clamp</span>(ndsi.img, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span></code></pre></div>
<p>For every image in the <code>rtoi</code>, the
<code>cloud_mask()</code> function generates a new image, called
<strong><em>mask</em></strong>, in which <span class="math inline">\(1\)</span>s and <span class="math inline">\(NA\)</span>s indicate clear and covered pixels.
The function identifies the mission/program and applies the appropriate
interpretation of bits to create the cloud mask. To import the result
run;</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>clds.msk <span class="ot">&lt;-</span> <span class="fu">rsat_get_raster</span>(filomena, <span class="st">&quot;mod09ga&quot;</span>, <span class="st">&quot;CloudMask&quot;</span>)</span></code></pre></div>
<p>In MODIS, cloud-masks have a different resolution than the
multispectral image. To adjust the resolution, <em>resample</em> the
cloud mask to match the resolution of the <em>NDSI</em> images
(<code>resample()</code>) using the nearest neighbor method
(<code>&quot;ngb&quot;</code>):</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>clds.msk <span class="ot">&lt;-</span> <span class="fu">resample</span>(clds.msk, ndsi.img, <span class="at">method =</span> <span class="st">&quot;ngb&quot;</span>)</span></code></pre></div>
<p>To apply the cloud mask, we just multiply both series of pixels. Dot
multiplications are performed pixel-wise. <em>NDSI</em> values
multiplied by <span class="math inline">\(1\)</span> remain unaltered
but those multiplied by <span class="math inline">\(NA\)</span> become
missing:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>ndsi.filt <span class="ot">&lt;-</span> ndsi.img <span class="sc">*</span> clds.msk</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="fu">names</span>(ndsi.filt) <span class="ot">&lt;-</span> <span class="fu">names</span>(clds.msk) <span class="co"># keep the names</span></span></code></pre></div>
<p>As an attempt to obtain a <strong><em>composite image</em></strong>,
we extract maximum value of the <em>NDSI</em> for each pixel in the time
series. Maximum value compositions are frequent in this field <span class="citation">(Holben 1986)</span>. Compositing is as a way to
summarize the information in a time-lapse and ignore the presence of
clouds:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>snow.spain <span class="ot">&lt;-</span> <span class="fu">calc</span>(ndsi.filt, max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>Represent the results:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="fu">tm_shape</span>(snow.spain) <span class="sc">+</span> <span class="fu">tm_raster</span>(<span class="at">style =</span> <span class="st">&quot;cont&quot;</span>)</span></code></pre></div>
<p>The results are not completely satisfactory. The image shows unfilled
gaps and this is because for those pixels there is no valid information
along the time-series. The following vignette explains how to process
images to fill gaps and smooth outliers.</p>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-holben1986characteristics" class="csl-entry">
Holben, Brent N. 1986. <span>“Characteristics of Maximum-Value Composite
Images from Temporal AVHRR Data.”</span> <em>International Journal of
Remote Sensing</em> 7 (11): 1417–34.
</div>
<div id="ref-salomonson2004estimating" class="csl-entry">
Salomonson, Vincent V, and I Appel. 2004. <span>“Estimating Fractional
Snow Cover from MODIS Using the Normalized Difference Snow
Index.”</span> <em>Remote Sensing of Environment</em> 89 (3): 351–60.
</div>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
